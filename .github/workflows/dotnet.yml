name: beta-release

on:
  push:
    branches: ["beta-release"]

jobs:
  build:
    runs-on: windows-latest

    steps:
      - name: Set git to use LF
        run: |
          git config --global core.autocrlf false
          git config --global core.eol crlf
      - uses: actions/checkout@v4
        name: Checkout Code
        with:
          fetch-depth: 0
      - name: Setup .NET Core SDK
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: "10.0.x"
          cache: true
          cache-dependency-path: src/**/*.csproj

      - name: Restore NuGet Packages
        run: dotnet restore src/BriefingRoom.sln

      - name: Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: yyMMdd-HHmmss
          utcOffset: "+00:00"

      - name: Set Build Version
        id: build_version
        run: |
          (Get-Content -path  src\BriefingRoom\BriefingRoom.cs -Raw) -replace '~BUILD_VERSION~','${{ steps.current-time.outputs.formattedTime }}' | Set-Content src\BriefingRoom\BriefingRoom.cs

      - name: Set Release Version
        id: release_version
        run: |
          (Get-Content -path  src\BriefingRoom\BriefingRoom.cs -Raw) -replace '~RELEASE_VERSION~','BETA' | Set-Content src\BriefingRoom\BriefingRoom.cs

      - name: Build and Publish App
        run: |
          dotnet publish src -c Release -p:Flavor=EXE -p:BRPublishDir=${{ github.workspace }}/BriefingRoom-build${{ steps.current-time.outputs.formattedTime }}/

      - name: Create Changelog
        id: change_log
        shell: bash
        run: |
          LOGS=$(git log --pretty=format:"%s" HEAD...$(git describe --abbrev=0 HEAD --tags) 2>/dev/null || echo "Initial release")
          echo "log<<EOF" >> $GITHUB_OUTPUT
          # Sort by category: Added, Updated, Fix, then alphabetically
          # Handles variants: Add/Added/Adds/Adding, Update/Updated/Updates/Updating, Fix/Fixed/Fixes/Fixing/Bugfix
          echo "$LOGS" | sort -u | awk '
            BEGIN { added=""; updated=""; fix=""; other="" }
            /^[Aa]dd(ed|s|ing)?[[:space:]]*:/ { added = added $0 "\n"; next }
            /^[Uu]pdat(e|ed|es|ing)[[:space:]]*:/ { updated = updated $0 "\n"; next }
            /^([Ff]ix(ed|es|ing)?|[Bb]ugfix)[[:space:]]*:/ { fix = fix $0 "\n"; next }
            { other = other $0 "\n" }
            END {
              printf "%s", added;
              printf "%s", updated;
              printf "%s", fix;
              printf "%s", other
            }
          ' >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Zip Release
        run: 7z a -tzip beta-release-${{ steps.current-time.outputs.formattedTime }}.zip BriefingRoom-build${{ steps.current-time.outputs.formattedTime }} "-xr!.git\" "-xr!.github\" "-xr!.git*" "-xr!.vscode\" "-xr!dataExtractors\"  "-xr!src\" "-xr!docs\" "-x!*.bat" "-x!*.filelist"

      - name: Upload Release
        uses: ncipollo/release-action@v1
        with:
          tag: "beta-release-${{ steps.current-time.outputs.formattedTime }}-${{ github.run_id }}-${{ github.run_attempt }}"
          name: "beta-release-${{ steps.current-time.outputs.formattedTime }}"
          body: |
            This is a automated beta build. This may not work. Its not recommend to overwrite a official release with this.
            ${{ steps.change_log.outputs.log }}
          prerelease: true
          artifacts: "beta-release-${{ steps.current-time.outputs.formattedTime }}.zip"
          token: ${{ secrets.GITHUB_TOKEN }}
      - name: Truncate Changelog for Discord
        id: discord_log
        shell: bash
        run: |
          HEADER="New Beta Release out https://github.com/DCS-BR-Tools/briefing-room-for-dcs/releases/tag/beta-release-${{ steps.current-time.outputs.formattedTime }}-${{ github.run_id }}-${{ github.run_attempt }}"
          LOG="${{ steps.change_log.outputs.log }}"
          HEADER_LEN=${#HEADER}
          MAX_LOG_LEN=$((2000 - HEADER_LEN - 10))  # Reserve space for newlines and ellipsis
          if [ ${#LOG} -gt $MAX_LOG_LEN ]; then
            LOG="${LOG:0:$MAX_LOG_LEN}..."
          fi
          echo "content<<EOF" >> $GITHUB_OUTPUT
          echo "$HEADER" >> $GITHUB_OUTPUT
          echo "$LOG" >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Post to Discord
        uses: tsickert/discord-webhook@v6.0.0
        with:
          webhook-url: ${{ secrets.DISCORD_WEBHOOK }}
          content: ${{ steps.discord_log.outputs.content }}

  docker:
    name: docker build and push
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Get current time
        uses: 1466587594/get-current-time@v2
        id: current-time
        with:
          format: YYMMDD-HHMMSS
          utcOffset: "+00:00"

      - name: Get current date
        uses: 1466587594/get-current-time@v2
        id: current-date
        with:
          format: YMM.DD
          utcOffset: "+00:00"

      - name: Set Build Version
        id: build_version
        run: |
          sed -i 's/~BUILD_VERSION~/${{ steps.current-time.outputs.formattedTime }}/g' ./src/BriefingRoom/BriefingRoom.cs

      - name: Set Release Version
        id: release_version
        run: |
          sed -i 's/~RELEASE_VERSION~/BETA/g' ./src/BriefingRoom/BriefingRoom.cs

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v3
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}
      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          push: true
          context: .
          tags: johnharvey/dcs-briefing-room-web:beta-${{ steps.current-time.outputs.formattedTime }}
