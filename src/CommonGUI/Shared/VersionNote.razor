@using BriefingRoom4DCS.UpdateService
@inject BriefingRoom4DCS.IBriefingRoom briefingRoom

@if (!BriefingRoom.RUNNING_IN_DOCKER && (Layout?.NewerMainRelease != null || Layout.NewerBetaRelease != null))
{
    <div class="version-note">
        @if (Layout.IsUpdating)
        {
            <div class="update-progress">
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: @Layout.DownloadProgress%"></div>
                </div>
                <small class="update-status">@Layout.UpdateStatus</small>
            </div>
        }
        else if (!string.IsNullOrEmpty(Layout.DownloadErrorMessage))
        {
            <small class="text-danger">@Layout.DownloadErrorMessage</small>
        }
        else
        {
            @if (Layout.NewerMainRelease != null)
            {
                <div class="update-row">
                    <span class="oi oi-cloud-download update-icon" title="@briefingRoom.Translate("NewReleaseAvailable")"></span>
                    <a href="@Layout.NewerMainRelease.HtmlUrl" target="_blank" class="update-version"
                           title="@Layout.NewerMainRelease.Name">
                        @Layout.NewerMainRelease.Name
                    </a>
                    <button class="btn btn-sm btn-primary update-btn" @onclick="() => StartUpdateAsync(false)">
                        @briefingRoom.Translate("UpdateNow")
                    </button>

                </div>
            }
            @if (Layout.NewerBetaRelease != null)
            {
                <div class="update-row beta">
                    <span class="oi oi-beaker update-icon" title="@briefingRoom.Translate("BetaReleaseAvailable")"></span>
                    <a href="@Layout.NewerBetaRelease.HtmlUrl" target="_blank" class="update-version"
                           title="@Layout.NewerBetaRelease.Name">
                        Beta: @Layout.NewerBetaRelease.Name
                    </a>

                    <button class="btn btn-sm btn-warning update-btn" @onclick="() => StartUpdateAsync(true)">
                        @briefingRoom.Translate("UpdateNow")
                    </button>

                </div>
            }
        }
    </div>
}
@code {
     [CascadingParameter]
    public MainLayout Layout { get; set; }

    private async Task StartUpdateAsync(bool useBeta)
    {
        Layout.IsUpdating = true;
        Layout.DownloadErrorMessage = "";
        StateHasChanged();

        try
        {

            Layout.UpdateStatus = briefingRoom.Translate("DownloadingUpdate");
            StateHasChanged();

            var extractedPath = await Layout.UpdateManager.DownloadUpdateAsync(useBeta ? Layout.NewerBetaRelease : Layout.NewerMainRelease);

            Layout.UpdateStatus = briefingRoom.Translate("InstallingUpdate");
            StateHasChanged();

            Layout.UpdateManager.LaunchUpdaterAndExit(extractedPath);
        }
        catch (Exception ex)
        {
            Layout.DownloadErrorMessage = $"{briefingRoom.Translate("UpdateFailed")}: {ex.Message}";
            Layout.IsUpdating = false;
            StateHasChanged();
        }
    }
}