@using BriefingRoom4DCS.UpdateService
@inject BriefingRoom4DCS.IBriefingRoom briefingRoom

@if (!BriefingRoom.RUNNING_IN_DOCKER && Layout?.MainRelease != null && Layout.MainRelease.versionNumber != BriefingRoom.VERSION)
{
    <div class="sidebar-update">
        @if (_isUpdating)
        {
            <div class="update-progress">
                <div class="progress" style="height: 4px;">
                    <div class="progress-bar" role="progressbar" style="width: @_downloadProgress%"></div>
                </div>
                <small class="update-status">@_updateStatus</small>
            </div>
        }
        else if (!string.IsNullOrEmpty(_errorMessage))
        {
            <small class="text-danger">@_errorMessage</small>
        }
        else
        {
            <div class="update-available">
                <span class="oi oi-cloud-download update-icon" title="@briefingRoom.Translate("NewReleaseAvailable")"></span>
                <div class="update-info">
                    <a href="@Layout.MainRelease.htmlUrl" target="_blank" class="update-version" title="@Layout.MainRelease.name">
                        @Layout.MainRelease.name
                    </a>
                    @if (UpdateManager.IsUpdateSupported)
                    {
                        <button class="btn btn-sm btn-primary update-btn" @onclick="() => StartUpdateAsync(false)">
                            @briefingRoom.Translate("UpdateNow")
                        </button>
                    }
                    else
                    {
                        <a href="@Layout.MainRelease.url" target="_blank" class="btn btn-sm btn-primary update-btn">
                            @briefingRoom.Translate("Download")
                        </a>
                    }
                </div>
            </div>
            @if (Layout.BetaRelease != null && Layout.BetaRelease.publishedDate.CompareTo(Layout.MainRelease.publishedDate) > 0)
            {
                <div class="update-available beta">
                    <span class="oi oi-beaker update-icon" title="@briefingRoom.Translate("BetaReleaseAvailable")"></span>
                    <div class="update-info">
                        <a href="@Layout.BetaRelease.htmlUrl" target="_blank" class="update-version" title="@Layout.BetaRelease.name">
                            Beta
                        </a>
                        @if (UpdateManager.IsUpdateSupported)
                        {
                            <button class="btn btn-sm btn-warning update-btn" @onclick="() => StartUpdateAsync(true)">
                                @briefingRoom.Translate("UpdateNow")
                            </button>
                        }
                        else
                        {
                            <a href="@Layout.BetaRelease.url" target="_blank" class="btn btn-sm btn-warning update-btn">
                                @briefingRoom.Translate("Download")
                            </a>
                        }
                    </div>
                </div>
            }
        }
    </div>
}

@code {
    [CascadingParameter]
    public MainLayout Layout { get; set; }

    private bool _isUpdating = false;
    private string _updateStatus = "";
    private int _downloadProgress = 0;
    private string _errorMessage = "";

    private async Task StartUpdateAsync(bool useBeta)
    {
        if (!UpdateManager.IsUpdateSupported || _isUpdating)
            return;

        _isUpdating = true;
        _errorMessage = "";
        _updateStatus = briefingRoom.Translate("CheckingForUpdates");
        StateHasChanged();

        try
        {
            var options = new UpdateOptions { IncludeBetaReleases = useBeta };
            using var updateManager = UpdateContext.CreateUpdateManager(options);

            updateManager.StatusChanged += status =>
            {
                _updateStatus = status;
                InvokeAsync(StateHasChanged);
            };

            updateManager.DownloadProgressChanged += progress =>
            {
                _downloadProgress = progress;
                InvokeAsync(StateHasChanged);
            };

            var release = await updateManager.CheckForUpdateAsync();
            if (release == null)
            {
                _updateStatus = briefingRoom.Translate("NoUpdateAvailable");
                _isUpdating = false;
                StateHasChanged();
                return;
            }

            _updateStatus = briefingRoom.Translate("DownloadingUpdate");
            StateHasChanged();

            var extractedPath = await updateManager.DownloadUpdateAsync(release);

            _updateStatus = briefingRoom.Translate("InstallingUpdate");
            StateHasChanged();

            updateManager.LaunchUpdaterAndExit(extractedPath);
        }
        catch (Exception ex)
        {
            _errorMessage = $"{briefingRoom.Translate("UpdateFailed")}: {ex.Message}";
            _isUpdating = false;
            StateHasChanged();
        }
    }
}
